<!DOCTYPE html>
<html>
<head>
    <title>é¦¬ä»£é›†é‹åŠ©æ‰‹ - ç¢ºèªæ¨¡å¼</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; text-align: center; padding: 15px; background: #f4f7f9; }
        #reader { width: 100%; max-width: 450px; margin: 0 auto 15px; border-radius: 8px; overflow: hidden; }
        .form-container { background: white; padding: 20px; border-radius: 12px; shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 450px; margin: auto; }
        
        input[type="text"] { width: 90%; padding: 12px; font-size: 18px; margin: 10px 0; border: 2px solid #ddd; border-radius: 6px; }
        
        .radio-group { display: flex; justify-content: space-around; margin: 15px 0; }
        .radio-item { font-size: 18px; display: flex; align-items: center; }
        .radio-item input { width: 20px; height: 20px; margin-right: 8px; }

        .submit-btn { background: #4CAF50; color: white; width: 100%; padding: 15px; font-size: 18px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .submit-btn:active { background: #388E3C; }

        .admin-btns { margin-top: 25px; display: flex; justify-content: center; gap: 10px; }
        .secondary-btn { padding: 8px 15px; font-size: 14px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #fff; }
        
        table { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 14px; background: white; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #f8f8f8; }
    </style>
</head>
<body>

    <h2>ğŸ“¦ é¦¬çˆ¾ä»£å¤«é›†é‹ç³»çµ±</h2>
    
    <div id="reader"></div>

    <div class="form-container">
        <label>æ¢ç¢¼å–®è™Ÿï¼š</label><br>
        <input type="text" id="barcodeInput" placeholder="ç­‰å¾…æƒææˆ–æ‰‹å‹•è¼¸å…¥...">
        
        <div class="radio-group">
            <label class="radio-item">
                <input type="radio" name="actionType" value="å…¥åº«" checked> å…¥åº«
            </label>
            <label class="radio-item">
                <input type="radio" name="actionType" value="å‡ºåº«"> å‡ºåº«
            </label>
        </div>

        <button class="submit-btn" onclick="submitRecord()">âœ… ç¢ºèªæäº¤</button>
    </div>

    <div class="admin-btns">
        <button class="secondary-btn" onclick="exportExcel()">åŒ¯å‡º Excel</button>
        <button class="secondary-btn" onclick="clearData()" style="color:red;">æ¸…ç©ºç´€éŒ„</button>
    </div>

    <table id="logTable">
        <thead>
            <tr><th>æ™‚é–“</th><th>å–®è™Ÿ</th><th>å‹•ä½œ</th></tr>
        </thead>
        <tbody id="logBody"></tbody>
    </table>

    <script>
        let scanData = JSON.parse(localStorage.getItem('scanData') || '[]');
        const barcodeInput = document.getElementById('barcodeInput');

        // åˆå§‹åŒ–æƒæå™¨
        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 15, qrbox: { width: 250, height: 120 } },
            (decodedText) => {
                barcodeInput.value = decodedText; // æƒææˆåŠŸå¾Œè‡ªå‹•å¡«å…¥
                if (navigator.vibrate) navigator.vibrate(50); // éœ‡å‹•æç¤º
            }
        ).catch(err => console.error("å•Ÿå‹•å¤±æ•—", err));

        // æäº¤ç´€éŒ„åˆ°æœ¬åœ°å­˜å„²
        function submitRecord() {
            const barcode = barcodeInput.value.trim();
            if (!barcode) {
                alert("è«‹å…ˆæƒææˆ–è¼¸å…¥æ¢ç¢¼ï¼");
                return;
            }

            const type = document.querySelector('input[name="actionType"]:checked').value;
            const now = new Date();
            const timeStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();

            const record = { time: timeStr, barcode: barcode, type: type };
            scanData.unshift(record); 
            localStorage.setItem('scanData', JSON.stringify(scanData));

            updateTable();
            barcodeInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
            alert(type + " æˆåŠŸï¼š" + barcode);
        }

        function updateTable() {
            const body = document.getElementById('logBody');
            body.innerHTML = scanData.slice(0, 10).map(r => `
                <tr><td>${r.time}</td><td>${r.barcode}</td><td>${r.type}</td></tr>
            `).join('');
        }

        function exportExcel() {
            if(scanData.length === 0) return alert("ç›®å‰æ²’æœ‰æ•¸æ“šå¯ä»¥åŒ¯å‡º");
            const worksheet = XLSX.utils.json_to_sheet(scanData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Logistics_Data");
            XLSX.writeFile(workbook, `Maldives_Cargo_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function clearData() {
            if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ")) {
                scanData = [];
                localStorage.removeItem('scanData');
                updateTable();
            }
        }

        updateTable();
    </script>
</body>
</html>
