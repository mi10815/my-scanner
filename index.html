<!DOCTYPE html>
<html>
<head>
    <title>é¦¬ä»£é›†é‹åŠ©æ‰‹ - æµæš¢ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; text-align: center; padding: 15px; background: #f4f7f9; margin: 0; }
        #reader { width: 100%; max-width: 450px; margin: 0 auto 15px; border-radius: 12px; overflow: hidden; background: #000; }
        .form-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-width: 450px; margin: auto; }
        
        input[type="text"] { width: 90%; padding: 15px; font-size: 20px; margin: 10px 0; border: 2px solid #eee; border-radius: 8px; outline: none; transition: border 0.3s; }
        input[type="text"]:focus { border-color: #4CAF50; }
        
        .radio-group { display: flex; justify-content: space-around; margin: 20px 0; }
        .radio-item { font-size: 18px; display: flex; align-items: center; cursor: pointer; }
        .radio-item input { width: 22px; height: 22px; margin-right: 10px; cursor: pointer; }

        .submit-btn { background: #4CAF50; color: white; width: 100%; padding: 18px; font-size: 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #388E3C; }
        .submit-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #388E3C; }

        /* è‡ªå‹•æ¶ˆå¤±çš„æç¤ºæ¡† (Toast) */
        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 30px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 50px; transform: translateX(-50%); font-size: 16px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 1.5s; }

        .admin-btns { margin-top: 30px; display: flex; justify-content: center; gap: 15px; }
        .secondary-btn { padding: 10px 18px; font-size: 14px; cursor: pointer; border: 1px solid #ccc; border-radius: 6px; background: #fff; color: #666; }
        
        table { width: 100%; margin-top: 25px; border-collapse: collapse; font-size: 14px; background: white; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #f8f8f8; color: #888; }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 50px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 50px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <h2 style="color: #2c3e50;">ğŸ“¦ é¦¬çˆ¾ä»£å¤«ç‰©æµåŠ©æ‰‹</h2>
    
    <div id="reader"></div>

    <div class="form-container">
        <input type="text" id="barcodeInput" placeholder="é»æ“Šé€™è£¡æˆ–æƒææ¢ç¢¼">
        
        <div class="radio-group">
            <label class="radio-item"><input type="radio" name="actionType" value="å…¥åº«" checked> å…¥åº«</label>
            <label class="radio-item"><input type="radio" name="actionType" value="å‡ºåº«"> å‡ºåº«</label>
        </div>

        <button class="submit-btn" onclick="submitRecord()">âœ… é»æ“Šç¢ºèªæäº¤</button>
    </div>

    <div id="toast">æˆåŠŸå„²å­˜ç´€éŒ„</div>

    <div class="admin-btns">
        <button class="secondary-btn" onclick="exportExcel()">åŒ¯å‡º Excel</button>
        <button class="secondary-btn" onclick="clearData()" style="color:#e74c3c;">æ¸…ç©ºç´€éŒ„</button>
    </div>

    <table id="logTable">
        <thead>
            <tr><th>æ™‚é–“</th><th>å–®è™Ÿ</th><th>é¡å‹</th></tr>
        </thead>
        <tbody id="logBody"></tbody>
    </table>

    <script>
        let scanData = JSON.parse(localStorage.getItem('scanData') || '[]');
        const barcodeInput = document.getElementById('barcodeInput');
        const toast = document.getElementById('toast');

        // åˆå§‹åŒ–æƒæå™¨
        const html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 20, qrbox: { width: 280, height: 150 } };

        function startScanner() {
            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                barcodeInput.value = decodedText;
                if (navigator.vibrate) navigator.vibrate(50);
            }).catch(err => console.error("æƒæå•Ÿå‹•å¤±æ•—", err));
        }

        function showToast(message, color = "#333") {
            toast.innerText = message;
            toast.style.backgroundColor = color;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2000);
        }

        function submitRecord() {
            const barcode = barcodeInput.value.trim();
            if (!barcode) {
                showToast("âŒ è«‹å…ˆè¼¸å…¥å–®è™Ÿ", "#e74c3c");
                return;
            }

            const type = document.querySelector('input[name="actionType"]:checked').value;
            const now = new Date();
            const timeStr = now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0') + ":" + now.getSeconds().toString().padStart(2, '0');

            const record = { time: timeStr, barcode: barcode, type: type };
            scanData.unshift(record); 
            localStorage.setItem('scanData', JSON.stringify(scanData));

            updateTable();
            barcodeInput.value = ''; 
            
            // é¡¯ç¤ºè‡ªå®šç¾©æç¤ºè€Œé Alert
            showToast(`âœ… ${type}æˆåŠŸ: ${barcode.slice(-6)}`, "#4CAF50");

            // é€™è£¡é—œéµï¼šæäº¤å¾Œä¸é‡æ–°åŠ è¼‰é é¢ï¼Œåªæ˜¯æ¸…ç©ºè¼¸å…¥æ¡†ï¼Œç›¸æ©Ÿä¾ç„¶åœ¨è·‘
        }

        function updateTable() {
            const body = document.getElementById('logBody');
            body.innerHTML = scanData.slice(0, 5).map(r => `
                <tr><td>${r.time}</td><td>${r.barcode}</td><td>${r.type}</td></tr>
            `).join('');
        }

        function exportExcel() {
            if(scanData.length === 0) return showToast("æš«ç„¡æ•¸æ“š", "#e74c3c");
            const worksheet = XLSX.utils.json_to_sheet(scanData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Records");
            XLSX.writeFile(workbook, `Logistics_${new Date().getMonth()+1}_${new Date().getDate()}.xlsx`);
        }

        function clearData() {
            if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰æ•¸æ“šï¼Ÿ")) {
                scanData = [];
                localStorage.removeItem('scanData');
                updateTable();
            }
        }

        // å•Ÿå‹•ç›¸æ©Ÿ
        startScanner();
        updateTable();
    </script>
</body>
</html>
