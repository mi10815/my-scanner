<!DOCTYPE html>
<html>
<head>
    <title>é¦¬ä»£é›†é‹åŠ©æ‰‹ - æ•¸é‡åŠ å¼·ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; text-align: center; padding: 15px; background: #f4f7f9; margin: 0; }
        #reader { width: 100%; max-width: 450px; margin: 0 auto 15px; border-radius: 12px; overflow: hidden; background: #000; }
        .form-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-width: 450px; margin: auto; }
        
        .input-label { text-align: left; display: block; margin-top: 10px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"] { width: 90%; padding: 12px; font-size: 18px; margin: 8px 0; border: 2px solid #eee; border-radius: 8px; outline: none; }
        
        /* æ•¸é‡èª¿ç¯€å™¨æ¨£å¼ */
        .qty-control { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 10px 0; }
        .qty-btn { width: 45px; height: 45px; background: #eee; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; }
        
        .radio-group { display: flex; justify-content: space-around; margin: 20px 0; }
        .radio-item { font-size: 18px; display: flex; align-items: center; }
        .radio-item input { width: 22px; height: 22px; margin-right: 8px; }

        .submit-btn { background: #4CAF50; color: white; width: 100%; padding: 18px; font-size: 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #388E3C; }
        .submit-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #388E3C; }

        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 30px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 50px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 1.5s; }

        .admin-btns { margin-top: 30px; display: flex; justify-content: center; gap: 15px; }
        .secondary-btn { padding: 10px 18px; font-size: 14px; cursor: pointer; border: 1px solid #ccc; border-radius: 6px; background: #fff; }
        
        table { width: 100%; margin-top: 25px; border-collapse: collapse; font-size: 14px; background: white; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #f8f8f8; }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 50px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 50px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <h2 style="color: #2c3e50;">ğŸ“¦ é¦¬ä»£ç‰©æµåŠ©æ‰‹ (æ•¸é‡ç‰ˆ)</h2>
    
    <div id="reader"></div>

    <div class="form-container">
        <span class="input-label">å–®è™Ÿï¼š</span>
        <input type="text" id="barcodeInput" placeholder="æƒææˆ–æ‰‹å‹•è¼¸å…¥">
        
        <span class="input-label">æ•¸é‡ï¼š</span>
        <div class="qty-control">
            <button class="qty-btn" onclick="adjustQty(-1)">-</button>
            <input type="number" id="qtyInput" value="1" style="width: 60px; text-align: center;">
            <button class="qty-btn" onclick="adjustQty(1)">+</button>
        </div>

        <div class="radio-group">
            <label class="radio-item"><input type="radio" name="actionType" value="å…¥åº«" checked> å…¥åº«</label>
            <label class="radio-item"><input type="radio" name="actionType" value="å‡ºåº«"> å‡ºåº«</label>
        </div>

        <button class="submit-btn" onclick="submitRecord()">âœ… ç¢ºèªæäº¤</button>
    </div>

    <div id="toast">æ“ä½œæˆåŠŸ</div>

    <div class="admin-btns">
        <button class="secondary-btn" onclick="exportExcel()">åŒ¯å‡º Excel</button>
        <button class="secondary-btn" onclick="clearData()" style="color:#e74c3c;">æ¸…ç©º</button>
    </div>

    <table id="logTable">
        <thead>
            <tr><th>æ™‚é–“</th><th>å–®è™Ÿ</th><th>æ•¸é‡</th><th>é¡å‹</th></tr>
        </thead>
        <tbody id="logBody"></tbody>
    </table>

    <script>
        let scanData = JSON.parse(localStorage.getItem('scanData') || '[]');
        const barcodeInput = document.getElementById('barcodeInput');
        const qtyInput = document.getElementById('qtyInput');
        const toast = document.getElementById('toast');

        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: { width: 280, height: 150 } }, (decodedText) => {
            barcodeInput.value = decodedText;
            if (navigator.vibrate) navigator.vibrate(50);
        }).catch(err => console.error(err));

        function adjustQty(val) {
            let current = parseInt(qtyInput.value) || 1;
            if (current + val >= 1) qtyInput.value = current + val;
        }

        function showToast(message, color = "#333") {
            toast.innerText = message;
            toast.style.backgroundColor = color;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2000);
        }

        function submitRecord() {
            const barcode = barcodeInput.value.trim();
            const qty = parseInt(qtyInput.value) || 1;
            if (!barcode) return showToast("âŒ ç„¡å–®è™Ÿ", "#e74c3c");

            const type = document.querySelector('input[name="actionType"]:checked').value;
            const now = new Date();
            const timeStr = now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');

            const record = { time: timeStr, barcode: barcode, qty: qty, type: type };
            scanData.unshift(record); 
            localStorage.setItem('scanData', JSON.stringify(scanData));

            updateTable();
            barcodeInput.value = '';
            qtyInput.value = '1'; // æäº¤å¾Œé‡ç½®æ•¸é‡ç‚º1
            showToast(`âœ… ${type}æˆåŠŸ (${qty}ä»¶)`, "#4CAF50");
        }

        function updateTable() {
            const body = document.getElementById('logBody');
            body.innerHTML = scanData.slice(0, 10).map(r => `
                <tr><td>${r.time}</td><td>${r.barcode}</td><td>${r.qty}</td><td>${r.type}</td></tr>
            `).join('');
        }

        function exportExcel() {
            if(scanData.length === 0) return;
            const worksheet = XLSX.utils.json_to_sheet(scanData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Records");
            XLSX.writeFile(workbook, `Maldives_Cargo_Log.xlsx`);
        }

        function clearData() {
            if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) {
                scanData = [];
                localStorage.removeItem('scanData');
                updateTable();
            }
        }

        updateTable();
    </script>
</body>
</html>
